<UserControl x:Class="ModsAutomator.Desktop.Views.LibraryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:ModsAutomator.Desktop.Services"
             Background="#121212">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
        <conv:InverseBoolToVisConverter x:Key="InverseBoolToVisConverter" />
        <conv:BoolToOpacityConverter x:Key="BoolToOpacityConverter" />
        <conv:ModReadyToCrawlConverter x:Key="ModReadyToCrawlConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <DockPanel Grid.Column="0" Margin="20">
            <Border DockPanel.Dock="Top" Background="#1E1E1E" Padding="15" CornerRadius="10" Margin="0,0,0,15">
                <DockPanel>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="{Binding SelectedApp.Name}" FontSize="20" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="{Binding SelectedApp.InstalledVersion, StringFormat='Target: {0}'}" Foreground="#2196F3" FontSize="11"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="+ Register Mod" Command="{Binding AddModShellCommand}" 
            Background="#2196F3" Foreground="White" Margin="0,0,10,0" Padding="12,5"/>

                        <Button Content="Crawl All" Command="{Binding CrawlAppCommand}" 
            Background="#252525" Foreground="#FFC107" Margin="0,0,10,0" Padding="12,5"/>

                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0" Background="#333"/>

                        <Button Command="{Binding NavToRetiredCommand}"
            Background="Transparent" Foreground="#666" BorderThickness="0" Margin="0,0,10,0"
            ToolTip="The permanent graveyard of wiped mods">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xED1A;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                <TextBlock Text="Retired History" VerticalAlignment="Center" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </DockPanel>
            </Border>

            <ListBox ItemsSource="{Binding Mods}" SelectedItem="{Binding SelectedMod}"
                     Background="Transparent" BorderThickness="0" HorizontalContentAlignment="Stretch">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Background="#1E1E1E" CornerRadius="8" Margin="5" Padding="15" Width="320">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <TextBlock Text="{Binding Shell.Name}" Foreground="White" FontWeight="Bold" FontSize="14"/>

                                <StackPanel Grid.Row="1" Margin="0,10">
                                    <TextBlock Text="{Binding Summary}" Foreground="#888" FontSize="12"/>
                                    <Border Visibility="{Binding Installed.IsUsed, Converter={StaticResource BooleanToVisibilityConverter}}" 
                                            Background="#2E4A2E" HorizontalAlignment="Left" CornerRadius="4" Padding="5,2" Margin="0,5,0,0">
                                        <TextBlock Text="ACTIVE" Foreground="#4CAF50" FontSize="9" FontWeight="Bold"/>
                                    </Border>
                                </StackPanel>

                                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="Update" 
                                            Command="{Binding DataContext.GoToCrawlerCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                            CommandParameter="{Binding}"
                                            Margin="0,0,5,0" Padding="10,2"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </DockPanel>

        <Border Grid.Column="1" Background="#181818" BorderBrush="#252525" BorderThickness="1,0,0,0" Padding="25">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0">
                    <TextBlock Text="MOD INSPECTOR" FontSize="11" Foreground="#444" Margin="0,0,0,20"/>
                    <TextBlock Text="{Binding SelectedMod.Shell.Name}" FontSize="22" FontWeight="Bold" Foreground="White"/>

                    <Button Command="{Binding GoToCrawlerCommand}" 
        CommandParameter="{Binding SelectedMod}"
        Margin="0,20,0,0" Padding="12" 
        Background="#252525" BorderBrush="#FFC107" BorderThickness="0,0,0,2">
                        <Button.IsEnabled>
                            <MultiBinding Converter="{StaticResource ModReadyToCrawlConverter}">
                                <Binding Path="SelectedMod" />
                                <Binding Path="SelectedMod.Installed.IsUsed" />
                            </MultiBinding>
                        </Button.IsEnabled>
                        <Button.Opacity>
                            <Binding Path="SelectedMod.Installed.IsUsed" Converter="{StaticResource BoolToOpacityConverter}" />
                        </Button.Opacity>
                        <DockPanel>
                            <TextBlock Text="" FontFamily="Segoe MDL2 Assets" Foreground="#FFC107" FontSize="16" Margin="0,0,12,0"/>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="Crawl for Updates" Foreground="White" FontWeight="SemiBold"/>
                                <TextBlock Text="Check source for new versions" Foreground="#666" FontSize="10"/>
                            </StackPanel>
                        </DockPanel>
                    </Button>

                    <Button Command="{Binding ShowHistoryCommand}" 
                            IsEnabled="{Binding SelectedMod, Converter={StaticResource NullToBoolConverter}}"
                            Background="#2A2A2A" Foreground="White" Height="35" Margin="0,10,0,0" BorderThickness="0">
                        <DockPanel HorizontalAlignment="Left" Margin="10,0">
                            <TextBlock Text="" FontFamily="Segoe MDL2 Assets" Margin="0,0,10,0" VerticalAlignment="Center"/>
                            <TextBlock Text="Show Mod History" VerticalAlignment="Center"/>
                        </DockPanel>
                    </Button>

                    <Separator Background="#222" Margin="0,15"/>

                    <Button Content="Edit Shell Metadata" 
                            Command="{Binding EditModShellCommand}" 
                            IsEnabled="{Binding SelectedMod, Converter={StaticResource NullToBoolConverter}}"
                            Background="#2A2A2A" Foreground="White" Height="35" Margin="0,0,0,0" BorderThickness="0"/>
                </StackPanel>

                <StackPanel Grid.Row="1">
                    <Button Content="Deactivate Mod" 
            Command="{Binding ToggleActivationCommand}" 
            Visibility="{Binding SelectedMod.Installed.IsUsed, Converter={StaticResource BooleanToVisibilityConverter}}"
            IsEnabled="{Binding SelectedMod, Converter={StaticResource NullToBoolConverter}}"
            Background="#333" Foreground="#BBB" Height="35" BorderThickness="0" Margin="0,0,0,10"/>

                    <Button Content="Activate Mod" 
            Command="{Binding ToggleActivationCommand}" 
            Visibility="{Binding SelectedMod.Installed.IsUsed, Converter={StaticResource InverseBoolToVisConverter}}"
            IsEnabled="{Binding SelectedMod, Converter={StaticResource NullToBoolConverter}}"
            Background="#4CAF50" Foreground="White" FontWeight="Bold" Height="35" BorderThickness="0" Margin="0,0,0,10"/>

                    <Button Command="{Binding HardWipeCommand}" 
                            IsEnabled="{Binding SelectedMod, Converter={StaticResource NullToBoolConverter}}"
                            Background="Transparent" BorderBrush="#442222" BorderThickness="1" Height="40">
                        <TextBlock Text="HARD WIPE IDENTITY" Foreground="#F44336" FontWeight="Bold" FontSize="11"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>