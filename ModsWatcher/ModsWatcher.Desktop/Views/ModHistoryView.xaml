<UserControl x:Class="ModsWatcher.Desktop.Views.ModHistoryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:ModsWatcher.Desktop.Services"
             Background="{DynamicResource WindowBackground}">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <conv:InverseBoolToVisConverter x:Key="InverseBoolToVis" />
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" Margin="0,0,0,20">
            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Bottom" Margin="10,0,0,4">
                <CheckBox IsChecked="{Binding OverrideRollbackRules}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                <TextBlock Text="OVERRIDE ROLLBACK RULES" Foreground="{DynamicResource TextSecondary}" FontSize="10" FontWeight="Black" VerticalAlignment="Center">
                    <TextBlock.ToolTip>
                        <ToolTip Content="Allow rollback to versions designed for different App versions."/>
                    </TextBlock.ToolTip>
                </TextBlock>
            </StackPanel>

            <StackPanel Orientation="Horizontal">
                <StackPanel>
                    <TextBlock Text="INSTALLATION HISTORY" Style="{DynamicResource InspectorSectionHeaderStyle}" />
                    <TextBlock Text="{Binding SelectedModName}" Style="{DynamicResource ModTitleTextStyle}" FontSize="24"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="25,0,0,4" VerticalAlignment="Bottom">
                    <TextBlock Text="FILTER APP:" Style="{DynamicResource SmallHeaderTextStyle}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox ItemsSource="{Binding AppVersionFilterOptions}" 
                              SelectedItem="{Binding SelectedAppVersionFilter}"
                              Width="110" Height="22" 
                              VerticalContentAlignment="Center" FontSize="11"
                              Background="{DynamicResource CardInnerSectionBackground}"
                              Foreground="{DynamicResource TextPrimary}"
                              BorderBrush="{DynamicResource BorderMuted}"/>
                </StackPanel>
            </StackPanel>
        </DockPanel>

        <Grid Grid.Row="1">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding HistoryItems}" 
                             Visibility="{Binding HasHistory, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="ItemBorder" Style="{DynamicResource HistoryRowStyle}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="180"/>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding History.InstalledAt, StringFormat='MMM dd, yyyy'}" Foreground="{DynamicResource TextPrimary}" FontWeight="SemiBold"/>
                                        <TextBlock Text="Date Installed" Foreground="{DynamicResource TextMuted}" FontSize="11"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding History.Version}" Foreground="{DynamicResource AccentPrimary}" FontSize="16" FontWeight="Bold"/>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="App: " Foreground="{DynamicResource TextMuted}" FontSize="10"/>
                                            <TextBlock Text="{Binding History.AppVersion}" Foreground="{DynamicResource TextSecondary}" FontSize="10" FontWeight="Bold"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="10,0">
                                        <Border x:Name="CompBadge" HorizontalAlignment="Left" Padding="8,2" CornerRadius="4" Background="{DynamicResource CardInnerSectionBackground}" Margin="0,0,0,5">
                                            <TextBlock x:Name="CompText" Text="COMPATIBLE" FontSize="9" FontWeight="Bold" Foreground="{DynamicResource AccentSuccess}"/>
                                        </Border>

                                        <StackPanel Orientation="Horizontal">
                                            <Button Style="{DynamicResource ActionIconButtonStyle}" 
                                                    ToolTip="Open Link" 
                                                    Command="{Binding DataContext.OpenUrlCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    CommandParameter="{Binding History.DownloadUrl}"
                                                    Margin="0,0,5,0">
                                                <TextBlock Text="&#xE896;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource AccentSuccess}" FontSize="12"/>
                                            </Button>
                                            <Button Style="{DynamicResource ActionIconButtonStyle}" 
                                                    ToolTip="Copy Link" 
                                                    Command="{Binding DataContext.CopyUrlCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                    CommandParameter="{Binding History.DownloadUrl}">
                                                <TextBlock Text="&#xE8C8;" FontFamily="Segoe MDL2 Assets" Foreground="{DynamicResource TextMuted}" FontSize="12"/>
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>

                                    <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Button Content="ROLLBACK" 
                                                Command="{Binding DataContext.RollbackCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                IsEnabled="{Binding CanRollback}"
                                                Style="{DynamicResource PrimaryActionButtonStyle}"
                                                Padding="15,6" Margin="0,0,10,0"/>

                                        <Button Command="{Binding DataContext.DeleteHistoryItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}"
                                                Style="{DynamicResource ActionIconButtonStyle}"
                                                ToolTip="Delete this history record">
                                            <TextBlock Text="&#xE74D;" 
                                                       FontFamily="Segoe MDL2 Assets" 
                                                       FontSize="14" 
                                                       Foreground="{DynamicResource AccentDanger}"/>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding IsCompatible}" Value="False">
                                    <Setter TargetName="CompText" Property="Text" Value="VERSION MISMATCH"/>
                                    <Setter TargetName="CompText" Property="Foreground" Value="{DynamicResource AccentDanger}"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        Visibility="{Binding HasHistory, Converter={StaticResource InverseBoolToVis}}">
                <TextBlock Text="&#xE7BA;" FontFamily="Segoe MDL2 Assets" FontSize="64" Foreground="{DynamicResource BorderMuted}" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                <TextBlock Text="No History Found" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource TextMuted}" HorizontalAlignment="Center"/>
                <TextBlock Text="This mod hasn't been updated since it was first installed." Foreground="{DynamicResource TextMuted}" HorizontalAlignment="Center" Margin="0,10,0,0"/>
            </StackPanel>
        </Grid>

        <Border Grid.Row="2" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource BorderMuted}" Padding="0,15,0,0">
            <Button Command="{Binding BackCommand}" Style="{DynamicResource GhostActionButtonStyle}" HorizontalAlignment="Left">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE72B;" FontFamily="Segoe MDL2 Assets" FontSize="12" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Back to Library" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Border>
    </Grid>
</UserControl>